<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.booklog.booklogbackend.mapper.BookMapper">

    <!-- 시스템 books 테이블에 신규 도서 등록(사용자 서재 등록 도서, 리뷰 작성된 도서) -->
    <insert id="insertBook" useGeneratedKeys="true" keyProperty="bookId">
        INSERT INTO
            books (
                isbn,
                book_title,
                book_link,
                book_img,
                book_author,
                book_discount,
                book_publisher,
                book_pub_date,
                book_description
        )
        VALUES (
                #{isbn},
                #{bookTitle},
                #{bookLink},
                #{bookImg},
                #{bookAuthor},
                #{bookDiscount},
                #{bookPublisher},
                #{bookPubDate},
                #{bookDescription}
               )
    </insert>

    <!-- 리뷰가 1건 이상 등록되어 있는 도서 조회 -->
    <select id="selectBooksWithReviewStatics" resultType="com.booklog.booklogbackend.Model.response.BookWithReviewStaticsResponse">
        SELECT
            b.book_id                   AS bookId,
            b.isbn                      AS isbn,
            b.book_title                AS title,
            b.book_author               AS author,
            b.book_img                  AS bookImg,
            ROUND(AVG(r.rating), 1)     AS rating,
            COUNT(r.review_id)          AS reviewCount
        FROM
            books b
                JOIN
            book_review r ON b.book_id = r.book_id
        GROUP BY
            b.book_id, b.book_title, b.book_author, b.book_img
        ORDER BY
            reviewCount DESC
    </select>

    <!-- 서재에서 readingStaus만 조회 -->
    <select id="selectBookcaseReadingStatus"
            resultType="string">
        SELECT reading_status
        FROM bookcase
        WHERE user_id = #{userId}
          AND book_id = #{bookId}
    </select>

    <!-- 도서 상세 조회 시 isbn으로 시스템에 등록된 도서 조회 -->
    <select id="findByIsbn" resultType="com.booklog.booklogbackend.Model.vo.BookVO">
        SELECT
            book_id             AS bookId,
            isbn                AS isbn,
            book_title          AS bookTitle,
            book_link           AS bookLink,
            book_img            AS bookImg,
            book_author         AS bookAuthor,
            book_discount       AS bookDiscount,
            book_publisher      AS bookPublisher,
            book_pub_date       AS bookPubDate,
            book_description    AS bookDescription
        FROM books
        WHERE isbn = #{isbn}
    </select>

    <select id="getBookByBookId" resultType="com.booklog.booklogbackend.Model.vo.BookVO">
        SELECT
            book_id             AS bookId,
            isbn                AS isbn,
            book_title          AS bookTitle,
            book_link           AS bookLink,
            book_img            AS bookImg,
            book_author         AS bookAuthor,
            book_discount       AS bookDiscount,
            book_publisher      AS bookPublisher,
            book_pub_date       AS bookPubDate,
            book_description    AS bookDescription
        FROM books
        WHERE book_id = #{bookId}
    </select>

    <select id="getReviewRequestBookByBookId" resultType="com.booklog.booklogbackend.Model.response.BookForNewReviewResponse">
        SELECT
            book_id             AS bookId,
            isbn                AS isbn,
            book_title          AS bookTitle,
            book_img            AS bookImg,
            book_author         AS bookAuthor,
            book_publisher      AS bookPublisher,
        FROM books
        WHERE book_id = #{bookId}
    </select>

</mapper>