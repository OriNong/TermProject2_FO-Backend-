<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.booklog.booklogbackend.mapper.BookcaseMapper">

    <!-- 1. 상태 조회 -->
    <select id="selectBookcaseStatus" resultType="com.booklog.booklogbackend.Model.vo.BookcaseVO">
        SELECT
            bookcase_id             AS bookcaseId,
            user_id                 AS userId,
            book_id                 AS bookId,
            reading_status          AS readingStatus,
            reading_started_at      AS readingStartedAt,
            reading_finished_at     AS readingFinishedAt,
            created_at              AS createdAt,
            updated_at              AS updatedAt
        FROM bookcase
        WHERE user_id = #{userId}
          AND book_id = #{bookId}
    </select>

    <!-- 서재의 도서 읽기 상태 변경 (독서 시작/독서 완료) -->
    <update id="updateBookcaseStatus">
        UPDATE bookcase
        SET reading_status = #{readingStatus},
            reading_started_at = CASE
                WHEN #{readingStatus} = 'READING' AND reading_started_at IS NULL THEN CURRENT_TIMESTAMP
                ELSE reading_started_at
            END,
            reading_finished_at = CASE
                WHEN #{readingStatus} = 'COMPLETED' THEN CURRENT_TIMESTAMP
                WHEN #{readingStatus} = 'READING' THEN NULL
                ELSE reading_finished_at
            END,
            updated_at = CURRENT_TIMESTAMP
        WHERE user_id = #{userId}
          AND book_id = #{bookId}
    </update>

    <!-- 사용자 서재에 도서 신규 등록 -->
    <insert id="insertBookcase" useGeneratedKeys="true" keyProperty="bookcaseId">
        INSERT INTO bookcase (
            user_id,
            book_id,
            reading_status,
            reading_started_at,
            reading_finished_at,
            created_at,
            updated_at
        ) VALUES (
                    #{userId},
                    #{bookId},
                    #{readingStatus},
                    #{readingStartedAt},
                    #{readingFinishedAt},
                    NOW(),
                    NOW()
                 )
    </insert>

    <!-- 사용자 서재 전체 조회 -->
    <select id="selectBookcaseByUserId" resultType="com.booklog.booklogbackend.Model.vo.BookcaseWithBookVO">
        SELECT
            b.book_id               AS bookId,
            b.book_title            AS bookTitle,
            b.book_img              AS bookImg,
            b.book_author           AS bookAuthor,
            bc.reading_status       AS readingStatus,
            bc.reading_started_at   AS readingStartedAt,
            bc.reading_finished_at  AS readingFinishedAt
        FROM bookcase bc
                 JOIN books b ON bc.book_id = b.book_id
        WHERE bc.user_id = #{userId}
        ORDER BY bc.updated_at DESC
    </select>

    <!-- 도서의 읽기 상태가 COMPLETED인지 조회 -->
    <select id="isBookReadCompleted" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM bookcase
        WHERE user_id = #{userId}
          AND book_id = #{bookId}
          AND reading_status = #{status}
    </select>


</mapper>