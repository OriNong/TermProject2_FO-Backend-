<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.booklog.booklogbackend.mapper.ReportMapper">

    <!-- 중복 신고 여부 확인 -->
    <select id="existsByUserAndReview" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM review_report              -- 리뷰 신고 테이블
        WHERE review_id = #{reviewId}
          AND reporter_id = #{userId}
    </select>

    <!-- 신고 등록 -->
    <insert id="insertReport">
        INSERT INTO review_report (
            review_id,
            reporter_id,
            reason_code,
            reason
        ) VALUES (
                     #{request.reviewId},
                     #{userId},
                     #{request.reasonCode},
                     #{request.reason}
                 )
    </insert>

    <!-- 내 신고 목록 조회 -->
    <select id="selectMyReports" resultType="com.booklog.booklogbackend.Model.response.ReviewReportResponse">
        SELECT
            rr.report_id AS reportId,
            rr.review_id AS reviewId,
            r.review_title AS reviewTitle,
            rr.reason_code AS reasonCode,
            rr.reason,
            rr.status,
            rr.reported_at AS reportedAt,
            rr.processed_at AS processedAt
        FROM review_report rr
                 JOIN book_review r ON rr.review_id = r.review_id
        WHERE rr.reporter_id = #{userId}
        ORDER BY rr.reported_at DESC
    </select>

    <!-- 수정 가능 여부 확인 -->
    <select id="isEditable" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM review_report
        WHERE report_id = #{reportId}
          AND reporter_id = #{userId}
          AND processed_at IS NULL
    </select>

    <!-- 신고 수정 -->
    <update id="updateReport">
        UPDATE review_report
        SET reason_code = #{request.reasonCode},
            reason = #{request.reason}
        WHERE report_id = #{reportId}
          AND reporter_id = #{userId}
    </update>

    <!-- 신고 삭제 -->
    <delete id="deleteReport">
        DELETE FROM review_report
        WHERE report_id = #{reportId}
          AND reporter_id = #{userId}
    </delete>

</mapper>